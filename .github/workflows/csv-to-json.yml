name: CSV → JSON (for GitHub Pages)

on:
  push:
    paths:
      - '**/statuses.csv'        # CSV 變更就觸發
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'       # 每 30 分跑一次（可改）

permissions:
  contents: write                # 允許推回 repo

env:
  PAGES_BRANCH: main             # ← 如果你的 Pages 用的是 gh-pages，就改成 gh-pages

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Pages branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PAGES_BRANCH }}   # 保證是在 Pages 分支上操作
          fetch-depth: 0

      - name: Locate CSV path
        id: findcsv
        run: |
          set -euo pipefail
          CSV_PATH="$(git ls-files | grep -E '(^|/)statuses\.csv$' || true)"
          if [ -z "$CSV_PATH" ]; then
            echo "❌ 找不到 statuses.csv（請確認檔名與路徑）"
            exit 1
          fi
          echo "csv=$CSV_PATH" >> "$GITHUB_OUTPUT"
          echo "✅ 找到 CSV：$CSV_PATH"

      - name: Convert CSV → JSON (tolerant headers)
        env:
          CSV_PATH: ${{ steps.findcsv.outputs.csv }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import csv, json, os, datetime, io
          CSV_PATH = os.environ['CSV_PATH']
          ALLOWED = {'未收到','已收件','二層核章','已完成核章送出'}

          def norm(s):
              if s is None: return ''
              s = str(s)
              for bad in ['\ufeff','\u00A0','\u3000','\u200b']:
                  s = s.replace(bad,'')
              return s.strip().lower()

          SYN_ID     = {'id','單號','資料單號','送件單號','案件編號','票號','編號','流水號','ticket','case id','case_id'}
          SYN_STATUS = {'status','狀態','目前狀態','進度','處理狀態','stage'}
          SYN_NOTE   = {'note','備註','備註說明','說明','comment','remark','備註欄'}

          # 讀檔：容錯多種編碼
          last_err = None
          for enc in ['utf-8-sig','utf-8','cp950','big5']:
              try:
                  text = open(CSV_PATH,'r',encoding=enc, newline='').read()
                  break
              except Exception as e:
                  last_err = e
          else:
              raise last_err

          # 猜分隔符（逗號/分號/Tab）
          try:
              sample = '\n'.join(text.splitlines()[:3])
              dialect = csv.Sniffer().sniff(sample, delimiters=',;\t')
