name: CSV â†’ JSON (for GitHub Pages)

on:
  push:
    paths:
      - '**/statuses.csv'        # CSV è®Šæ›´å°±è§¸ç™¼
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'       # æ¯ 30 åˆ†è·‘ä¸€æ¬¡ï¼ˆå¯æ”¹ï¼‰

permissions:
  contents: write                # å…è¨±æ¨å› repo

env:
  PAGES_BRANCH: main             # â† å¦‚æœä½ çš„ Pages ç”¨çš„æ˜¯ gh-pagesï¼Œå°±æ”¹æˆ gh-pages

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Pages branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PAGES_BRANCH }}   # ä¿è­‰æ˜¯åœ¨ Pages åˆ†æ”¯ä¸Šæ“ä½œ
          fetch-depth: 0

      - name: Locate CSV path
        id: findcsv
        run: |
          set -euo pipefail
          CSV_PATH="$(git ls-files | grep -E '(^|/)statuses\.csv$' || true)"
          if [ -z "$CSV_PATH" ]; then
            echo "âŒ æ‰¾ä¸åˆ° statuses.csvï¼ˆè«‹ç¢ºèªæª”åèˆ‡è·¯å¾‘ï¼‰"
            exit 1
          fi
          echo "csv=$CSV_PATH" >> "$GITHUB_OUTPUT"
          echo "âœ… æ‰¾åˆ° CSVï¼š$CSV_PATH"

      - name: Convert CSV â†’ JSON (tolerant headers)
        env:
          CSV_PATH: ${{ steps.findcsv.outputs.csv }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import csv, json, os, datetime, io
          CSV_PATH = os.environ['CSV_PATH']
          ALLOWED = {'æœªæ”¶åˆ°','å·²æ”¶ä»¶','äºŒå±¤æ ¸ç« ','å·²å®Œæˆæ ¸ç« é€å‡º'}

          def norm(s):
              if s is None: return ''
              s = str(s)
              for bad in ['\ufeff','\u00A0','\u3000','\u200b']:
                  s = s.replace(bad,'')
              return s.strip().lower()

          SYN_ID     = {'id','å–®è™Ÿ','è³‡æ–™å–®è™Ÿ','é€ä»¶å–®è™Ÿ','æ¡ˆä»¶ç·¨è™Ÿ','ç¥¨è™Ÿ','ç·¨è™Ÿ','æµæ°´è™Ÿ','ticket','case id','case_id'}
          SYN_STATUS = {'status','ç‹€æ…‹','ç›®å‰ç‹€æ…‹','é€²åº¦','è™•ç†ç‹€æ…‹','stage'}
          SYN_NOTE   = {'note','å‚™è¨»','å‚™è¨»èªªæ˜','èªªæ˜','comment','remark','å‚™è¨»æ¬„'}

          # è®€æª”ï¼šå®¹éŒ¯å¤šç¨®ç·¨ç¢¼
          last_err = None
          for enc in ['utf-8-sig','utf-8','cp950','big5']:
              try:
                  text = open(CSV_PATH,'r',encoding=enc, newline='').read()
                  break
              except Exception as e:
                  last_err = e
          else:
              raise last_err

          # çŒœåˆ†éš”ç¬¦ï¼ˆé€—è™Ÿ/åˆ†è™Ÿ/Tabï¼‰
          try:
              sample = '\n'.join(text.splitlines()[:3])
              dialect = csv.Sniffer().sniff(sample, delimiters=',;\t')
          except Exception:
              dialect = None

          reader = csv.reader(io.StringIO(text), dialect) if dialect else csv.reader(io.StringIO(text))
          rows = [[c if c is not None else '' for c in row] for row in reader]
          if not rows:
              raise SystemExit("CSV å…§ç„¡è³‡æ–™")

          raw_headers = rows[0]
          headers = [norm(h) for h in raw_headers]
          print("ğŸ‘‰ è®€åˆ°çš„æ¬„åï¼ˆæ­£è¦åŒ–å¾Œï¼‰ï¼š", headers)

          def find_idx(syns):
              for i,h in enumerate(headers):
                  if h in syns:
                      return i
              return -1

          i_id   = find_idx(SYN_ID)
          i_st   = find_idx(SYN_STATUS)
          i_note = find_idx(SYN_NOTE)

          if min(i_id, i_st) < 0:
              raise SystemExit(f"CSV å¿…é ˆåŒ…å« id/status æˆ– å–®è™Ÿ/ç‹€æ…‹ï¼Œç›®å‰ç¬¬ä¸€åˆ—ç‚ºï¼š{raw_headers}")

          def get(r,i):
              return (r[i].strip() if i>=0 and i<len(r) and r[i] is not None else '')

          items = []
          for r in rows[1:]:
              if not any(str(x).strip() for x in r):  # è·³éç©ºåˆ—
                  continue
              idv = get(r,i_id).upper()
              if not idv:
                  continue
              st = get(r,i_st)
              if st not in ALLOWED:
                  st = 'æœªæ”¶åˆ°'
              note = get(r,i_note) if i_note >= 0 else ''
              items.append({'id': idv, 'status': st, 'note': note})

          items.sort(key=lambda x: x['id'])
          data = {
              'last_updated': datetime.datetime.now(datetime.timezone(datetime.timedelta(hours=8))).isoformat(),
              'items': items
          }
          with open('statuses.json','w',encoding='utf-8', newline='\n') as out:
              json.dump(data, out, ensure_ascii=False, indent=2)
              out.write('\n')
          PY

      - name: Preview JSON
        run: |
          echo "----- statuses.json (preview) -----"
          head -n 60 statuses.json || true
          echo "----- end preview -----"

      - name: Commit & push if changed
        run: |
          set -euo pipefail
          git pull --rebase --autostash || true
          if git status --porcelain statuses.json | grep -q .; then
            git config user.name  "github-actions"
            git config user.email "actions@github.com"
            git add statuses.json
            git commit -m "chore: update statuses.json from CSV"
            git push
            echo "âœ… å·²æ›´æ–°ä¸¦æ¨é€ statuses.json åˆ° ${{ env.PAGES_BRANCH }}"
          else
            echo "â„¹ï¸ ç„¡è®Šæ›´ï¼Œç•¥éæäº¤"
          fi
